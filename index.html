<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rastreador Táctico AN-32B | Responsive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet"/>

  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; background: #000; }

    /* --- HUD RESPONSIVE --- */
    #hud {
      position: absolute;
      z-index: 9999;
      background: rgba(0,0,0,0.85);
      color: #00ff41; 
      padding: 15px;
      border: 1px solid #00ff41;
      font: 12px 'Courier New', monospace;
      box-shadow: 0 0 15px rgba(0,255,65,0.2);
      transition: all 0.3s ease;
    }

    /* Estilo PC (Lateral) */
    @media (min-width: 768px) {
      #hud {
        top: 10px;
        left: 10px;
        width: 280px;
        border-radius: 8px;
      }
    }

    /* Estilo Móvil (Inferior) */
    @media (max-width: 767px) {
      #hud {
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        border-radius: 15px 15px 0 0;
        border-left: none;
        border-right: none;
        border-bottom: none;
        padding: 10px;
        box-sizing: border-box;
      }
      .hud-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      hr { margin: 5px 0 !important; }
    }

    #terrainAlert {
      display: none;
      color: #ff4444;
      font-weight: bold;
      text-align: center;
      border: 1px solid #ff4444;
      padding: 4px;
      margin-top: 5px;
      animation: blink 0.6s infinite;
      font-size: 10px;
    }

    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

    #dot{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:5px; background:#ff4444; }
    .label { color: #00ff41; text-transform: uppercase; font-size: 9px; opacity: 0.7; display: block; }
    .stat { color: #fff; font-weight: bold; font-size: 13px; }
    hr { border: 0; border-top: 1px solid rgba(0,255,65,0.3); margin: 8px 0; }
    .unit { font-size: 9px; color: #00ff41; margin-left: 2px; }
    .warning-text { color: #ff4444 !important; }
    .info-block { margin-bottom: 4px; }
  </style>
</head>

<body>
  <div id="hud">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span><span id="dot"></span> <span id="linkStatus" style="font-size: 10px;">OFFLINE</span></span>
      <span id="last" style="font-size:9px; opacity:0.6">--:--:--</span>
    </div>
    
    <hr>
    
    <div class="hud-grid">
      <div class="info-block">
        <span class="label">Radar Alt (AGL)</span>
        <span id="agl" class="stat">--</span><span class="unit">FT</span>
      </div>
      
      <div class="info-block">
        <span class="label">V. Speed (VSI)</span>
        <span id="vsi" class="stat">--</span><span class="unit">FPM</span>
      </div>

      <div class="info-block">
        <span class="label">MSL Altitude</span>
        <span id="altft" class="stat">--</span><span class="unit">FT</span>
      </div>

      <div class="info-block">
        <span class="label">Ground Speed</span>
        <span id="spd" class="stat">--</span><span class="unit">KM/H</span>
      </div>
    </div>

    <div id="terrainAlert">⚠️ LOW TERRAIN CLEARANCE ⚠️</div>
    
    <hr>
    
    <div style="font-size: 9px; line-height: 1.4;">
      <span class="label">METAR / ENV</span>
      <span id="env" style="color: #fff;">CARGANDO ATMÓSFERA...</span><br>
      <span class="label">Weather 200km</span>
      <span id="wx200" style="color: #fff;">--</span>
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const WEATHER_POLL_MS = 60000;
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyMWEwZTAwZS0wYWVjLTQ1ZmUtOGY2OC05NmVjZmQ5OTNhZTEiLCJpZCI6Mzg2Nzc5LCJpYXQiOjE3NzAxNzUzMDB9.Myivn9P57mAFArlOhP_dXj-CmANbGiUnwmTXssotP_o";

    const firebaseConfig = {
      apiKey: "AIzaSyCDHpTxxw0XObZFaG4G7VRVl8-ouszM5e8",
      authDomain: "tracker-an32b.firebaseapp.com",
      databaseURL: "https://tracker-an32b-default-rtdb.firebaseio.com",
      projectId: "tracker-an32b",
    };

    const hud = {
        link: document.getElementById("linkStatus"),
        terrainAlert: document.getElementById("terrainAlert"),
        wx: document.getElementById("wx200"),
        spd: document.getElementById("spd"),
        altft: document.getElementById("altft"),
        agl: document.getElementById("agl"),
        vsi: document.getElementById("vsi"),
        env: document.getElementById("env"),
        last: document.getElementById("last")
    };

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      timeline: false, animation: false, shadows: true,
      navigationHelpButton: false, sceneModePicker: false, fullscreenButton: false
    });

    const plane = viewer.entities.add({
      label: { text: "AN-32B", font: "10px monospace", pixelOffset: new Cesium.Cartesian2(0, -15) },
      point: { pixelSize: 8, color: Cesium.Color.RED }
    });
    viewer.trackedEntity = plane;

    let trailPoints = [];
    viewer.entities.add({
      polyline: {
        positions: new Cesium.CallbackProperty(() => trailPoints, false),
        width: 3, material: new Cesium.PolylineGlowMaterialProperty({ color: Cesium.Color.RED, glowPower: 0.1 })
      }
    });

    const weatherRing = viewer.entities.add({
      ellipse: { semiMajorAxis: 200000, semiMinorAxis: 200000, material: Cesium.Color.LIME.withAlpha(0.1), outline: true, outlineColor: Cesium.Color.LIME }
    });

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let lastFix = null;
    let lastWxAt = 0;

    async function fetchAtmosphere(lat, lon) {
        if (Date.now() - lastWxAt < WEATHER_POLL_MS) return;
        lastWxAt = Date.now();
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code,precipitation,wind_speed_10m,wind_direction_10m,surface_pressure`;
            const res = await fetch(url);
            const data = await res.json();
            const c = data.current;

            let level = (c.weather_code >= 95 || c.precipitation >= 5) ? "red" : (c.precipitation > 1 ? "yellow" : "green");
            hud.wx.textContent = `${c.precipitation.toFixed(1)}mm (${level.toUpperCase()})`;
            hud.env.textContent = `${c.wind_speed_10m}km/h @ ${c.wind_direction_10m}° | ${c.surface_pressure}hPa`;
            
            const color = level === "red" ? Cesium.Color.RED : (level === "yellow" ? Cesium.Color.YELLOW : Cesium.Color.LIME);
            weatherRing.ellipse.material = color.withAlpha(0.1);
            weatherRing.ellipse.outlineColor = color;
        } catch (e) { }
    }

    async function calculateAGL(lat, lon, altMSL) {
        const carto = Cesium.Cartographic.fromDegrees(lon, lat);
        try {
            const [sampled] = await Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [carto]);
            if (sampled) {
                const groundHeight = sampled.height;
                const aglFeet = (altMSL - groundHeight) * 3.28084;
                hud.agl.textContent = Math.max(0, aglFeet).toFixed(0);
                
                if (aglFeet < 1000) {
                    hud.terrainAlert.style.display = "block";
                    hud.agl.classList.add("warning-text");
                } else {
                    hud.terrainAlert.style.display = "none";
                    hud.agl.classList.remove("warning-text");
                }
            }
        } catch (e) { }
    }

    onValue(ref(db, "an32/position"), (snap) => {
      const d = snap.val();
      if (!d) return;

      const pos = Cesium.Cartesian3.fromDegrees(d.lon, d.lat, d.alt);
      plane.position = pos;
      weatherRing.position = pos;
      trailPoints.push(pos);
      if(trailPoints.length > 500) trailPoints.shift();

      if (lastFix) {
          const dt = (Date.now() - lastFix.time) / 1000;
          const vsi = ((d.alt - lastFix.alt) * 3.28084) / (dt / 60);
          hud.vsi.textContent = (vsi > 0 ? "+" : "") + vsi.toFixed(0);
          const dist = Cesium.Cartesian3.distance(Cesium.Cartesian3.fromDegrees(lastFix.lon, lastFix.lat), Cesium.Cartesian3.fromDegrees(d.lon, d.lat));
          hud.spd.textContent = ((dist / dt) * 3.6).toFixed(1);
      }

      hud.altft.textContent = (d.alt * 3.28084).toFixed(0);
      hud.last.textContent = new Date().toLocaleTimeString();
      
      calculateAGL(d.lat, d.lon, d.alt);
      fetchAtmosphere(d.lat, d.lon);
      
      lastFix = { lat: d.lat, lon: d.lon, alt: d.alt, time: Date.now() };
      document.getElementById("dot").style.background = "#00ff41";
      hud.link.textContent = "ONLINE";
    });
  </script>
</body>
</html>